<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Councils - å¯¹è®®ç‰Œ</title>
    <style>
        :root { --gold: #c5a059; --gold-br: #f3d9a9; --red-p: #d13d40; --panel: rgba(15, 15, 15, 0.98); }
        body { font-family: 'Garamond', serif; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; background-color: #050505; color: #dcdcdc; min-height: 100vh; }
        #gameContainer { width: 95%; max-width: 600px; padding: 15px; border: 1px solid var(--gold); background: var(--panel); box-shadow: 0 0 30px #000; position: relative; }
        header { text-align: center; border-bottom: 1px solid var(--gold); margin-bottom: 10px; }
        header h1 { font-size: 20px; color: var(--gold-br); letter-spacing: 4px; margin: 5px; }

        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; }
        .stat-card { background: rgba(197, 160, 89, 0.1); border: 1px solid #333; padding: 5px; text-align: center; }
        .stat-value { font-size: 16px; color: var(--gold); font-weight: bold; }

        #comment-section { background: rgba(30, 30, 30, 0.6); border: 1px double var(--gold-br); padding: 12px; margin: 10px 0; min-height: 55px; border-left: 4px solid var(--gold); }
        #comment-name { color: var(--gold-br); font-weight: bold; font-size: 13px; margin-bottom: 4px; display: block; }
        #comment-text { font-style: italic; color: #ddd; font-size: 14px; line-height: 1.4; }

        .battle-layout { display: flex; gap: 10px; margin-bottom: 10px; }
        .player-box { flex: 1; padding: 10px; border: 1px solid #222; text-align: center; min-height: 120px; position: relative; }
        .hand { display: flex; gap: 4px; justify-content: center; flex-wrap: wrap; margin-top: 8px; }
        
        .card { width: 40px; height: 58px; background: #fff; border-radius: 3px; color: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; font-size: 12px; border: 1px solid #999; }
        .card.red-suit { color: var(--red-p); }
        .card.selected { transform: translateY(-5px); border: 2px solid var(--gold); box-shadow: 0 0 8px var(--gold); }
        .card.ai-hidden { background: #222; border-color: #444; color: transparent !important; pointer-events: none; }

        .settlement-hall { border: 1px dashed var(--gold); padding: 8px; text-align: center; font-size: 13px; color: var(--gold-br); min-height: 20px; }
        .controls { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; margin-top: 15px; }
        button { background: #000; border: 1px solid var(--gold); color: var(--gold); padding: 8px 12px; cursor: pointer; font-size: 12px; }
        button:hover { background: var(--gold); color: #000; }

        .archive { width: 95%; max-width: 600px; margin-top: 15px; border: 1px solid #333; padding: 10px; font-size: 11px; background: rgba(0,0,0,0.3); }
        .log-container { max-height: 180px; overflow-y: auto; }
        .round-row { border-bottom: 1px solid #222; padding: 6px 0; }
        .mini-card { padding: 0 2px; font-weight: bold; border: 1px solid #555; background: #eee; border-radius: 2px; margin-right: 2px; color: #111; }
        .mini-card.red { color: var(--red-p); }

        #rule-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; border: 2px solid var(--gold); padding: 25px; max-width: 450px; position: relative; color: #ccc; font-size: 13px; line-height: 1.7; }
        .rule-item { margin-bottom: 10px; }
        .highlight { color: var(--gold-br); font-weight: bold; }
    </style>
</head>
<body>

<div id="gameContainer">
    <header><h1>COUNCILS å¯¹è®®ç‰Œ</h1></header>

    <div class="dashboard">
        <div class="stat-card">Player A<br><span id="s-p" class="stat-value">0</span></div>
        <div class="stat-card">Round<br><span id="s-r" class="stat-value">-</span></div>
        <div class="stat-card">Deck<br><span id="s-d" class="stat-value">54</span></div>
        <div class="stat-card">Opponent<br><span id="s-ai" class="stat-value">0</span></div>
    </div>

    <div id="comment-section">
        <span id="comment-name">æ¢å¯†é™¢ä¾ä»</span>
        <span id="comment-text">â€œè¯·é€‰æ‹©å¯¹æˆ˜æ¨¡å¼ä»¥å¼€å¯è®®ç¨‹ã€‚â€</span>
    </div>

    <div class="battle-layout" id="field" style="opacity:0.3; pointer-events:none;">
        <div class="player-box">
            <div id="role-p" style="font-size:10px; color:var(--gold)">-</div>
            <div class="hand" id="hand-p"></div>
        </div>
        <div class="player-box">
            <div id="role-ai" style="font-size:10px; color:var(--gold)">-</div>
            <div class="hand" id="hand-ai"></div>
        </div>
    </div>

    <div id="status" class="settlement-hall">ç­‰å¾…å¼€å±€...</div>

    <div class="controls">
        <button id="btn-pve" onclick="start(true)">äººæœºæ¨¡å¼</button>
        <button id="btn-pvp" onclick="start(false)">åŒäººæ¨¡å¼</button>
        <button id="btn-sub" style="display:none;" onclick="settle()">æäº¤ææ¡ˆ</button>
        <button id="btn-next" style="display:none;" onclick="next()">ä¸‹ä¸€è½®</button>
        <button onclick="toggleRules(true)">æŸ¥çœ‹æ³•åˆ™</button>
        <button onclick="softReset()">é‡ç½®</button>
    </div>
</div>

<div class="archive">
    <div style="color:var(--gold); border-bottom: 1px solid #444; padding-bottom:3px;">ğŸ›ï¸ è®®äº‹æ¡£æ¡ˆ</div>
    <div id="log" class="log-container"></div>
</div>

<div id="rule-modal">
    <div class="modal-content">
        <h3 style="color:var(--gold); margin-top:0; text-align:center;">æ¢å¯†é™¢è®®äº‹æ³•åˆ™</h3>
        <div class="rule-item">1. <span class="highlight">åŒç›¸æ‰£ç‰Œï¼š</span>åŒæ–¹æ¯è½®å¯é€‰æ‹© 1 æˆ– 2 å¼ æ‰‹ç‰Œæš—ç½®ã€‚</div>
        <div class="rule-item">2. <span class="highlight">åŒè‰²åˆ¤å®šï¼š</span>è‹¥åœºä¸Šæ‰€æœ‰å¼ƒç‰Œé¢œè‰²ä¸€è‡´ï¼Œåˆ™è¯¥é¢œè‰²çš„å¯¹è‰²æ–¹ç›´æ¥è·èƒœï¼ˆå…¨çº¢åˆ™é»‘æ–¹èƒœï¼Œåä¹‹äº¦ç„¶ï¼‰ã€‚</div>
        <div class="rule-item">3. <span class="highlight">ç‚¹æ•°è®¡ç®—ï¼š</span>è®®ç‚¹ = (è¯¥è‰²æ€»ç‚¹æ•° / è¯¥è‰²å¼ æ•°)ï¼Œç»“æœ<span class="highlight">å‘ä¸Šå–æ•´</span>ã€‚JQKç®—11-13ç‚¹ï¼ŒAç®—1ç‚¹ã€‚</div>
        <div class="rule-item">4. <span class="highlight">ç‹ç‰Œå½’å±ï¼š</span><br>
            - <span style="color:var(--red-p)">å¤§ç‹ï¼š</span>å¼ºåˆ¶è§†ä¸ºçº¢è‰²ï¼Œç‚¹æ•°ä¸º 0ã€‚<br>
            - <span>å°ç‹ï¼š</span>å¼ºåˆ¶è§†ä¸ºé»‘è‰²ï¼Œç‚¹æ•°ä¸º 0ã€‚</div>
        <div class="rule-item">5. <span class="highlight">å› æœç¿»è½¬ï¼š</span>è‹¥åœºä¸Šå‡ºç°<span class="highlight">å•æ•°å¼ ç‹ç‰Œ</span>ï¼Œè¯¥è½®æœ€ç»ˆçš„èƒœè´Ÿåˆ¤å®šå°†å‘ç”Ÿé€†è½¬ã€‚</div>
        <button onclick="toggleRules(false)" style="width:100%; margin-top:10px; background:none; color:var(--gold); border:1px solid var(--gold); padding:8px; cursor:pointer;">çŸ¥æ™“äº†</button>
    </div>
</div>

<script>
    let deck = [], pHand = [], aiHand = [], pSel = [], aiSel = [], pScore = 0, aiScore = 0, round = 0, isPvE = true, pIsRed = true;

    const charMap = {
        "ä¼¯çˆµä»£ç†äºº": ["ç‰©æå¿…åï¼Œç››æå¿…è¡°ï¼Œä¸æ˜¯å—ï¼Ÿ", "æ²‰é»˜åœ¨æ­¤æ—¶æœªå¿…ä¸æ˜¯ä¸€ä»¶åäº‹ã€‚", "ä¸€åˆ‡éƒ½ä¼šå°˜åŸƒè½å®šï¼Œæˆ‘çš„æœ‹å‹ã€‚"],
        "æ¢å¯†å¿": ["ä¸€åˆ‡éƒ½ä¼šå°˜åŸƒè½å®šï¼Œæˆ‘çš„æœ‹å‹ã€‚", "ä½ éœ€è¦å°½å¿«åšå‡ºå†³å®šï¼Œæ—¶é—´ä¸å¤šäº†ã€‚", "æ²‰é»˜åœ¨æ­¤æ—¶æœªå¿…ä¸æ˜¯ä¸€ä»¶åäº‹ã€‚"],
        "è€ç»ƒæ‰§æ”¿å®˜": ["æ•é”çš„å—…è§‰ã€‚çœ‹æ¥ä¸€åˆ‡éƒ½åœ¨è®¡ç®—ä¸­ã€‚", "ä¹Ÿè®¸æ‚¨å¯ä»¥å†è€ƒè™‘ä¸€ä¸‹åˆ«çš„ç­–ç•¥ã€‚", "çœŸç›¸æ˜­ç„¶è‹¥æ­ï¼Œæˆ‘ä»¬å¿…é¡»é‡‡å–è¡ŒåŠ¨ã€‚"],
        "ä¹¦è®°å‘˜": ["é‡å¤´å†æ¥ï¼Œæˆ–è®¸æ‚¨è¿˜æœ‰å†æ¥ä¸€æ¬¡çš„æœºä¼šã€‚", "çœŸç›¸æ˜­ç„¶è‹¥æ­ï¼Œæˆ‘ä»¬å¿…é¡»é‡‡å–è¡ŒåŠ¨ã€‚", "è¯­è¨€çš„åŠ›é‡åœ¨äºæ„ŸåŠ¨äººå¿ƒã€‚"],
        "é™ªå®¡å›¢ä»£è¡¨": ["ç²¾å½©çš„è§‚ç‚¹ç¢°æ’ï¼Œè¯·ç»§ç»­è®¨è®ºå§ã€‚", "è¯­è¨€çš„åŠ›é‡åœ¨äºæ„ŸåŠ¨äººå¿ƒã€‚", "ä¸€åˆ‡éƒ½ä¼šå°˜åŸƒè½å®šï¼Œæˆ‘çš„æœ‹å‹ã€‚"],
        "å åœå¸ˆ": ["å‘½è¿æŒ‡å¼•æ‚¨ç›¸ä¿¡æ­£ä½è€…çš„ç›´è§‰ã€‚", "æˆ‘çœ‹åˆ°äº†ä½ æ‚²æƒ¨çš„æœªæ¥ã€‚", "æ„¿å‡è¡¡ä¿ä½‘æ‚¨ï¼Œè¿™æ˜¯ç¥çš„æ—¨æ„ã€‚"],
        "ç¥çˆ¶": ["æ„¿å‡è¡¡ä¿ä½‘æ‚¨ï¼Œè¿™æ˜¯ç¥çš„æ—¨æ„ã€‚", "ä¹Ÿè®¸æ‚¨å¯ä»¥å†è€ƒè™‘ä¸€ä¸‹åˆ«çš„ç­–ç•¥ã€‚", "æ˜‚é¦–æŒºèƒ¸ï¼Œåšå®šä½ çš„æ„å¿—ã€‚"],
        "æ•™æˆ": ["åšå¼ˆæ˜¯ç§‘å­¦çš„ï¼Œä¸€åˆ‡é€‰æ‹©éƒ½æœ‰è¿¹å¯å¾ªã€‚", "æ•é”çš„å—…è§‰ã€‚çœ‹æ¥ä¸€åˆ‡éƒ½åœ¨è®¡ç®—ä¸­ã€‚", "ç²¾å½©çš„è§‚ç‚¹ç¢°æ’ï¼Œè¯·ç»§ç»­è®¨è®ºå§ã€‚"],
        "å°†å†›": ["è°ˆåˆ¤æ€»ä¼šç ´è£‚ï¼Œå”¯æœ‰å¯¹æŠ—é•¿å­˜ã€‚", "æ˜‚é¦–æŒºèƒ¸ï¼Œåšå®šä½ çš„æ„å¿—ã€‚", "ä½ éœ€è¦å°½å¿«åšå‡ºå†³å®šï¼Œæ—¶é—´ä¸å¤šäº†ã€‚"],
        "å›½ç‹": ["ç‰©æå¿…åï¼Œç››æå¿…è¡°ï¼Œä¸æ˜¯å—ï¼Ÿ", "æ˜‚é¦–æŒºèƒ¸ï¼Œåšå®šä½ çš„æ„å¿—ã€‚", "ä½ éœ€è¦å°½å¿«åšå‡ºå†³å®šï¼Œæ—¶é—´ä¸å¤šäº†ã€‚"],
        "éª‘å£«": ["æ˜‚é¦–æŒºèƒ¸ï¼Œåšå®šä½ çš„æ„å¿—ã€‚", "è°ˆåˆ¤æ€»ä¼šç ´è£‚ï¼Œå”¯æœ‰å¯¹æŠ—é•¿å­˜ã€‚", "å‘½è¿æŒ‡å¼•æ‚¨ç›¸ä¿¡æ­£ä½è€…çš„ç›´è§‰ã€‚"]
    };

    function speak() {
        const names = Object.keys(charMap);
        const name = names[Math.floor(Math.random()*names.length)];
        const lines = charMap[name];
        document.getElementById('comment-name').innerText = name;
        document.getElementById('comment-text').innerText = `â€œ${lines[Math.floor(Math.random()*lines.length)]}â€`;
    }

    function toggleRules(s) { document.getElementById('rule-modal').style.display = s?'flex':'none'; }

    function softReset() {
        pScore = 0; aiScore = 0; round = 0; pHand = []; aiHand = []; pSel = []; aiSel = [];
        document.getElementById('log').innerHTML = '';
        document.getElementById('status').innerText = "è®®ç¨‹å·²é‡ç½®ã€‚";
        document.getElementById('field').style.opacity = "0.3";
        document.getElementById('field').style.pointerEvents = "none";
        document.getElementById('btn-pve').style.display = 'inline-block';
        document.getElementById('btn-pvp').style.display = 'inline-block';
        document.getElementById('btn-sub').style.display = 'none';
        document.getElementById('btn-next').style.display = 'none';
        update();
    }

    function start(pve) {
        isPvE = pve; round = 1; pIsRed = true; deck = [];
        const suits = ['â™¥','â™¦','â™ ','â™£'], vals = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        suits.forEach(s => vals.forEach(v => deck.push({v, s, c: (s=='â™¥'||s=='â™¦'?'red':'black')})));
        deck.push({v:'å¤§ç‹', s:'ğŸƒ', c:'red', j:true}, {v:'å°ç‹', s:'ğŸƒ', c:'black', j:true});
        deck.sort(() => Math.random()-0.5);
        draw();
        document.getElementById('btn-pve').style.display = 'none';
        document.getElementById('btn-pvp').style.display = 'none';
        document.getElementById('btn-sub').style.display = 'inline-block';
        document.getElementById('field').style.opacity = "1";
        document.getElementById('field').style.pointerEvents = "all";
        if(isPvE) aiPick();
        speak(); update();
    }

    function draw() {
        while(pHand.length < 4 && deck.length > 0) pHand.push(deck.pop());
        while(aiHand.length < 4 && deck.length > 0) aiHand.push(deck.pop());
    }

    // AI å‡ºç‰Œé€»è¾‘ä¿®æ”¹ï¼šéšæœºé€‰æ‹© 1 å¼ æˆ– 2 å¼ 
    function aiPick() { 
        const count = Math.floor(Math.random() * 2) + 1; // 1 æˆ– 2
        aiSel = [0,1,2,3].sort(() => Math.random()-0.5).slice(0, count); 
    }

    function settle() {
        if(!pSel.length || (!isPvE && !aiSel.length)) return alert("è¯·å®Œæˆæ‚¨çš„æ‰£ç‰Œææ¡ˆã€‚");
        const pCards = pSel.map(i => pHand[i]);
        const aiCards = aiSel.map(i => aiHand[i]);
        const pool = [...pCards, ...aiCards];
        const colors = new Set(pool.map(c=>c.c));
        let winColor = '', msg = '';

        const getPt = (v) => { if(v=='A')return 1; if(v=='J')return 11; if(v=='Q')return 12; if(v=='K')return 13; return parseInt(v)||0; };
        const calc = (col) => {
            const sub = pool.filter(c => c.c == col);
            if(!sub.length) return 0;
            // å‘ä¸Šå–æ•´
            return Math.ceil(sub.reduce((acc, card) => acc + (card.j ? 0 : getPt(card.v)), 0) / sub.length);
        };

        if(colors.size == 1) {
            winColor = (pool[0].c == 'red' ? 'BLACK' : 'RED');
            msg = `åŒè‰²è½è´¥(${pool[0].c=='red'?'çº¢':'é»‘'})`;
        } else {
            const rA = calc('red'), bA = calc('black');
            winColor = rA > bA ? 'RED' : (bA > rA ? 'BLACK' : 'BOTH');
            // ç‹ç‰Œç¿»è½¬é€»è¾‘
            if(pool.filter(c=>c.j).length % 2 != 0 && winColor !== 'BOTH') {
                winColor = (winColor == 'RED' ? 'BLACK' : 'RED');
                msg = `çº¢${rA} vs é»‘${bA} (ç‹ç‰Œç¿»è½¬)`;
            } else {
                msg = `çº¢${rA} vs é»‘${bA}`;
            }
        }

        if(winColor == 'RED') (pIsRed ? pScore++ : aiScore++);
        else if(winColor == 'BLACK') (!pIsRed ? pScore++ : aiScore++);
        else { pScore++; aiScore++; }

        const log = document.getElementById('log');
        const mini = (cards) => cards.map(c=>`<span class="mini-card ${c.c=='red'?'red':''}">${c.s}${c.v}</span>`).join('');
        log.innerHTML = `<div class="round-row">R${round} [${msg}] <b>${winColor}èƒœ</b><br>P1: ${mini(pCards)} | P2: ${mini(aiCards)}</div>` + log.innerHTML;

        pHand = pHand.filter((_,i)=>!pSel.includes(i));
        aiHand = aiHand.filter((_,i)=>!aiSel.includes(i));
        pSel = []; aiSel = [];
        document.getElementById('btn-sub').style.display = 'none';
        document.getElementById('btn-next').style.display = 'inline-block';
        document.getElementById('status').innerText = `æœ¬è½®åˆ¤å®šï¼š${winColor}æ–¹èƒœåˆ©`;
        speak(); update(true);
    }

    function next() {
        pIsRed = !pIsRed; round++; draw();
        if(!pHand.length) return alert("ç‰Œå †å·²ç©ºï¼Œè®®äº‹ç»“æŸã€‚");
        document.getElementById('btn-sub').style.display = 'inline-block';
        document.getElementById('btn-next').style.display = 'none';
        if(isPvE) aiPick();
        update();
    }

    function update(reveal = false) {
        document.getElementById('s-p').innerText = pScore;
        document.getElementById('s-ai').innerText = aiScore;
        document.getElementById('s-r').innerText = round || '-';
        document.getElementById('s-d').innerText = deck.length;
        document.getElementById('role-p').innerText = pIsRed ? "çº¢æ–¹(æ”»)" : "é»‘æ–¹(å®ˆ)";
        document.getElementById('role-ai').innerText = pIsRed ? "é»‘æ–¹(å®ˆ)" : "çº¢æ–¹(æ”»)";

        const render = (container, hand, sel, isOpponent) => {
            container.innerHTML = '';
            hand.forEach((c, i) => {
                const d = document.createElement('div');
                // é®è”½é€»è¾‘ï¼šPvEæ¨¡å¼ä¸‹ç»“ç®—å‰ï¼ŒAIåŒºåŸŸä¸æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
                if(isOpponent && isPvE && !reveal) {
                    d.className = `card ai-hidden`;
                } else {
                    const isSelected = sel.includes(i);
                    d.className = `card ${c.c=='red'?'red-suit':''} ${isSelected?'selected':''}`;
                    d.innerHTML = `<span>${c.v}</span><small>${c.s}</small>`;
                    d.onclick = () => {
                        if(isOpponent && isPvE) return;
                        if(sel.includes(i)) sel.splice(sel.indexOf(i),1);
                        else if(sel.length < 2) sel.push(i);
                        update();
                    };
                }
                container.appendChild(d);
            });
        };
        render(document.getElementById('hand-p'), pHand, pSel, false);
        render(document.getElementById('hand-ai'), aiHand, aiSel, true);
    }
</script>
</body>
</html>
